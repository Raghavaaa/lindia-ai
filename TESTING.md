# AI Engine Testing Guide

## Testing the AI Engine Service

### Prerequisites

- Service deployed and running
- Valid JWT token for authentication
- Access to Railway internal network (or local development setup)

---

## 1. Health Check Test

**No authentication required**

```bash
curl http://ai-engine.railway.internal/health
```

**Expected Response**:
```json
{
  "status": "ok",
  "uptime": 123.45,
  "version": "1.0.0"
}
```

---

## 2. Generate JWT Token for Testing

### Using Python

```python
import jwt
from datetime import datetime, timedelta

def generate_test_token(tenant_id="test_tenant"):
    payload = {
        "tenant_id": tenant_id,
        "iat": datetime.utcnow(),
        "exp": datetime.utcnow() + timedelta(minutes=5),
    }
    
    # Use your INTERNAL_JWT_SECRET value
    secret = "your-internal-jwt-secret-here"
    
    token = jwt.encode(payload, secret, algorithm="HS256")
    return token

# Generate token
test_token = generate_test_token()
print(f"JWT Token: {test_token}")
```

### Using JWT.io

1. Go to [jwt.io](https://jwt.io)
2. Select **HS256** algorithm
3. Set payload:
   ```json
   {
     "tenant_id": "test_tenant",
     "iat": 1234567890,
     "exp": 1234571490
   }
   ```
4. Set secret: Your `INTERNAL_JWT_SECRET` value
5. Copy the generated token

---

## 3. Test Inference Endpoint

```bash
# Set your JWT token
export JWT_TOKEN="your-generated-token-here"

# Test inference
curl -X POST http://ai-engine.railway.internal/inference \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "What is Section 420 of the Indian Penal Code?",
    "context": "User is asking about criminal law provisions in India.",
    "tenant_id": "test_tenant"
  }'
```

**Expected Response**:
```json
{
  "answer": "Legal answer generated by INLEGALBERT for query: What is Section 420...",
  "sources": ["IPC Section 420", "CrPC Section 145"],
  "model": "INLEGALBERT",
  "latency_ms": 245.67
}
```

---

## 4. Test Embed Endpoint

```bash
curl -X POST http://ai-engine.railway.internal/embed \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "doc_id": "legal_doc_123",
    "text": "This is a sample legal document text that needs to be embedded for vector search. It contains relevant case law and statutory references."
  }'
```

**Expected Response**:
```json
{
  "vector_id": "vec_legal_doc_123_1234567890",
  "vector_meta": {
    "doc_id": "legal_doc_123",
    "dimensions": 768,
    "model": "sentence-transformers/legal-bert",
    "latency_ms": 89.23
  }
}
```

---

## 5. Test Search Endpoint

```bash
curl -X POST http://ai-engine.railway.internal/search \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "property dispute cases in India",
    "top_k": 5,
    "tenant_id": "test_tenant"
  }'
```

**Expected Response**:
```json
{
  "results": [
    {
      "doc_id": "doc_1",
      "score": 0.95,
      "metadata": {
        "title": "Legal Document 1",
        "type": "case_law",
        "date": "2024-01-15"
      },
      "snippet": "Relevant text snippet from document 1..."
    }
  ],
  "total_count": 5,
  "latency_ms": 67.89
}
```

---

## 6. Test Error Cases

### Missing Authorization Header

```bash
curl -X POST http://ai-engine.railway.internal/inference \
  -H "Content-Type: application/json" \
  -d '{"query": "test", "context": "test", "tenant_id": "test"}'
```

**Expected**: 401 Unauthorized
```json
{
  "error": "unauthorized_missing_token",
  "status_code": 401,
  "request_id": "abc-123-xyz"
}
```

### Invalid JWT Token

```bash
curl -X POST http://ai-engine.railway.internal/inference \
  -H "Authorization: Bearer invalid-token-here" \
  -H "Content-Type: application/json" \
  -d '{"query": "test", "context": "test", "tenant_id": "test"}'
```

**Expected**: 401 Unauthorized
```json
{
  "error": "unauthorized_invalid_token",
  "status_code": 401,
  "request_id": "abc-123-xyz"
}
```

### Payload Too Large

```bash
# Create a 6MB payload (exceeds 5MB limit)
python3 << 'EOF'
import requests
import json

large_text = "x" * (6 * 1024 * 1024)  # 6 MB

response = requests.post(
    "http://ai-engine.railway.internal/inference",
    headers={
        "Authorization": "Bearer your-token-here",
        "Content-Type": "application/json",
    },
    json={
        "query": "test",
        "context": large_text,
        "tenant_id": "test"
    }
)

print(response.status_code)
print(response.json())
EOF
```

**Expected**: 413 Payload Too Large
```json
{
  "error": "payload_too_large",
  "detail": "Payload exceeds maximum size of 5242880 bytes",
  "max_size_mb": 5.0
}
```

### Rate Limit Test

```bash
# Send 101 requests rapidly (exceeds 100/min limit)
for i in {1..101}; do
  curl -X POST http://ai-engine.railway.internal/inference \
    -H "Authorization: Bearer $JWT_TOKEN" \
    -H "Content-Type: application/json" \
    -d '{"query":"test","context":"test","tenant_id":"test_tenant"}' &
done
wait
```

**Expected**: First 100 succeed, 101st returns 429
```json
{
  "error": "rate_limit_exceeded",
  "message": "Rate limit of 100 requests per minute exceeded",
  "retry_after_seconds": 60
}
```

---

## 7. Load Testing

### Using Apache Bench (ab)

```bash
# Install ab
# macOS: brew install httpd
# Linux: apt-get install apache2-utils

# Test with 100 requests, 10 concurrent
ab -n 100 -c 10 \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -p payload.json \
  http://ai-engine.railway.internal/inference
```

**payload.json**:
```json
{
  "query": "test query",
  "context": "test context",
  "tenant_id": "test_tenant"
}
```

### Using Artillery

```yaml
# artillery-test.yml
config:
  target: "http://ai-engine.railway.internal"
  phases:
    - duration: 60
      arrivalRate: 10
  defaults:
    headers:
      Authorization: "Bearer your-token-here"
      Content-Type: "application/json"

scenarios:
  - name: "Inference Load Test"
    flow:
      - post:
          url: "/inference"
          json:
            query: "Sample legal query"
            context: "Sample context"
            tenant_id: "load_test"
```

Run:
```bash
artillery run artillery-test.yml
```

---

## 8. Smoke Test Suite

Run the built-in smoke tests:

```bash
# From the ai-engine directory
python3 << 'EOF'
import asyncio
from utils.smoke_test import run_smoke_tests

async def main():
    passed = await run_smoke_tests()
    if passed:
        print("\n✅ All smoke tests passed!")
    else:
        print("\n❌ Some smoke tests failed!")
    
asyncio.run(main())
EOF
```

---

## 9. Integration Tests

### Test from Main Backend

Create a test endpoint in your main backend:

```python
# app/routes/test.py

from fastapi import APIRouter
import httpx
import jwt
from datetime import datetime, timedelta
from app.core.config import settings

router = APIRouter()

@router.get("/test-ai-engine")
async def test_ai_engine():
    """Test AI Engine integration."""
    
    # Generate JWT
    payload = {
        "tenant_id": "integration_test",
        "iat": datetime.utcnow(),
        "exp": datetime.utcnow() + timedelta(minutes=5),
    }
    token = jwt.encode(
        payload,
        settings.AI_ENGINE_JWT_SECRET,
        algorithm="HS256"
    )
    
    # Test inference
    async with httpx.AsyncClient() as client:
        response = await client.post(
            f"{settings.AI_ENGINE_URL}/inference",
            headers={
                "Authorization": f"Bearer {token}",
                "Content-Type": "application/json",
            },
            json={
                "query": "Integration test query",
                "context": "Integration test context",
                "tenant_id": "integration_test",
            },
            timeout=30.0,
        )
    
    return {
        "status": "success" if response.status_code == 200 else "failed",
        "status_code": response.status_code,
        "response": response.json() if response.status_code == 200 else response.text,
    }
```

---

## 10. Monitoring Test Results

### Check Logs for Test Activity

```bash
# View logs during testing
railway logs --tail

# Filter for test tenant
railway logs | grep "test_tenant"

# Check for errors
railway logs | grep "ERROR"
```

### Verify Metrics

1. Railway Dashboard → AI Engine → Metrics
2. During load test, verify:
   - Request rate increases
   - CPU usage stays below 60% (or scales up)
   - Response time stays reasonable (<500ms p95)
   - Error rate stays low (<1%)

---

## Test Checklist

- [ ] Health endpoint returns 200 OK
- [ ] Inference endpoint with valid JWT returns 200
- [ ] Embed endpoint with valid JWT returns 200
- [ ] Search endpoint with valid JWT returns 200
- [ ] Missing JWT returns 401
- [ ] Invalid JWT returns 401
- [ ] Large payload returns 413
- [ ] Rate limit exceeded returns 429
- [ ] All endpoints return request_id in response
- [ ] Logs show structured JSON format
- [ ] Provider fallback works (if primary fails)
- [ ] Response times < 500ms for typical requests
- [ ] Smoke tests pass

---

## Troubleshooting Tests

| Issue | Solution |
|-------|----------|
| Connection refused | Check service is running: `railway status` |
| 401 Unauthorized | Verify JWT secret matches, token not expired |
| 404 Not Found | Check endpoint URL, ensure trailing slashes correct |
| Timeout | Check service logs, may need to scale up |
| Rate limit hit | Wait 60 seconds or use different tenant_id |

---

## Automated Testing

For CI/CD integration, create a test script:

```bash
#!/bin/bash
# test-ai-engine.sh

set -e

echo "Testing AI Engine..."

# 1. Health check
echo "Testing /health endpoint..."
HEALTH=$(curl -s http://ai-engine.railway.internal/health)
echo $HEALTH | grep -q '"status":"ok"' || exit 1

# 2. Generate JWT
JWT_TOKEN=$(python3 -c "
import jwt
from datetime import datetime, timedelta
payload = {'tenant_id': 'ci_test', 'iat': datetime.utcnow(), 'exp': datetime.utcnow() + timedelta(minutes=5)}
print(jwt.encode(payload, '$INTERNAL_JWT_SECRET', algorithm='HS256'))
")

# 3. Test inference
echo "Testing /inference endpoint..."
RESPONSE=$(curl -s -X POST http://ai-engine.railway.internal/inference \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"query":"test","context":"test","tenant_id":"ci_test"}')
echo $RESPONSE | grep -q '"answer"' || exit 1

echo "✅ All tests passed!"
```

Make executable and run:
```bash
chmod +x test-ai-engine.sh
./test-ai-engine.sh
```

---

## Performance Benchmarks

Target performance metrics:

| Endpoint | p50 Latency | p95 Latency | p99 Latency |
|----------|-------------|-------------|-------------|
| /health | <10ms | <20ms | <50ms |
| /inference | <300ms | <500ms | <1000ms |
| /embed | <100ms | <200ms | <400ms |
| /search | <150ms | <300ms | <600ms |

Run benchmarks and compare against these targets.

